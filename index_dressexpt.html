<!DOCTYPE html>
<html>



<head>
    <title>Dress Appeal</title>
    <meta charset="UTF-8">

    <!-- jsPsych v7 core -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>

    <!-- Plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.0.0"></script>

    <!-- Styles -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <!-- Your image list -->
    <script src="dress_list.js"></script>
    <script src="experiment_config.js"></script>

    <!-- Pavlovia plugin must come last -->
    <script src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>

    <!-- jsPsych v7 CSS -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />


    <style>
        /* Style slider track and thumbs for better contrast */
        .jspsych-html-slider-response input[type=range] {
            height: 8px;
            background: #ddd;
        }

        .jspsych-html-slider-response input[type=range]::-webkit-slider-thumb {
            background: #000;
            border: 2px solid #444;
            height: 20px;
            width: 20px;
            margin-top: -6px;
            border-radius: 50%;
        }

        .jspsych-html-slider-response input[type=range]::-moz-range-thumb {
            background: #000;
            border: 2px solid #444;
            height: 20px;
            width: 20px;
            border-radius: 50%;
        }

        /* Add prominent tick markers */
        .jspsych-html-slider-response .jspsych-slider-label {
            font-size: 1em;
            font-weight: bold;
            color: #222;
        }

        .jspsych-content img {
            width: 300px;
            height: auto;
        }
    </style>
    <style>
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-screen" style="text-align: center; font-family: Arial, sans-serif; padding-top: 20vh;">
        <h2>Loading experiment...</h2>
        <p>Please wait a moment.</p>
    </div>
</body>
<script type="module">
    // Experiment configuration is now loaded via external file: experiment_config.js

    let consent_html = '';

    // Fetch consent information with robust error handling and then start experiment
    (async function loadConsentAndStart() {
        try {
            const response = await fetch('consent_information.html');
            if (!response.ok) {
                throw new Error('Failed to load consent information');
            }
            consent_html = await response.text();
        } catch (error) {
            console.error('Error loading consent information:', error);
            consent_html = `
      <div style="text-align:left; max-width: 800px; margin: auto;">
        <h2>Participant Information Statement</h2>
        <p><b>Error:</b> We could not load the full Participant Information Statement. Please ensure you are connected to the internet or contact the research team.</p>
        <p><b>Contact:</b> Prof. Thomas Carlson – thomas.carlson@sydney.edu.au</p>
      </div>
    `;
        }
        startExperiment();
    })();

    function shuffle_trials(imageList) {

        var shuffledList = imageList.slice();
        var j, x, i;
        for (i = shuffledList.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = shuffledList[i];
            shuffledList[i] = shuffledList[j];
            shuffledList[j] = x;
        }

        return shuffledList;
    }

    // All experiment logic is now inside startExperiment()

    function make_blocks(imageList) {

        let suffledimages = shuffle_trials(imageList);
        console.log(suffledimages)
        let FullList = suffledimages;

        for (let b = displayTimings.nBlocks - 1; b > 0; b--) {
            suffledimages = shuffle_trials(imageList);
            console.log(suffledimages)
            FullList = FullList.concat(suffledimages);
        }
        console.log(FullList.length)
        console.log(FullList)

        return FullList;

    }

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }


    function startExperiment() {
        // Hide the loading screen
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
        }

        let timeline = [];
        const jsPsych = initJsPsych({
            timeline: timeline,
            on_finish: function () {
                if (LocalSave) {
                    console.log("OFFLINE END OF EXPT");
                    endExperiment(jsPsych.data.get().csv(), function () { });
                    jsPsych.data.get().localSave('csv', 'dress_ratings.csv');
                }
            }
        });

        if (!jsPsych.data.get().select('platform').values.length) {
            if (devMode) {
                jsPsych.data.addProperties({ platform: "Development" });
            } else {
                jsPsych.data.addProperties({ platform: "Unknown" });
            }
        }

        const promptString = 'Using the slider, rate how <b>much you like</b> the dress you saw in the image';
        const sliderString = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];

        if (flowFlags.Is3014) {
            let payment_amount = "3014 Class Research credit"
        } else {
            let payment_amount = experimentMeta.payment
        }

        let image_stimuli;
        if (flowFlags.isFullVersion) {
            image_stimuli = dresses;  // load from dress_list.js
        } else {
            // Short version for testing: first 3 dresses
            image_stimuli = dresses.slice(0, 3);
        }

        // Unified participant ID detection and fallback
        const prolificID = jsPsych.data.getURLVariable('PROLIFIC_PID');
        const mturkID = jsPsych.data.getURLVariable('workerId');

        var IsProlific = !!prolificID;
        var IsMTurk = !!mturkID;

        if (IsProlific) {
            jsPsych.data.addProperties({
                participantID: prolificID,
                platform: "Prolific"
            });
        } else if (IsMTurk) {
            jsPsych.data.addProperties({
                participantID: mturkID,
                platform: "MTurk"
            });
        }

        // If no participantID detected, request manual entry
        if (!jsPsych.data.get().select('participantID').values.length) {
            var getUserID = {
                type: jsPsychSurveyHtmlForm,
                preamble: '<p><b>Please enter your Participant ID</b></p><p>(This is required for payment or credit.)</p>',
                html: '<p>Participant ID: <input type="text" id="participant-id" name="participantID" size="20" required /></p>',
                autofocus: 'participant-id',
                on_finish: function (data) {
                    var participantID = data.response.participantID;
                    jsPsych.data.addProperties({
                        participantID: participantID,
                        platform: "Manual Entry"
                    });
                }
            };
            timeline.push(getUserID);
        }

        var pavlovia_init = {
            type: jsPsychPavlovia,
            command: "init"
        };
        timeline.push(pavlovia_init);

        var preload = {
            type: jsPsychPreload,
            auto_preload: true
        }
        timeline.push(preload);

        const consentTrial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: () => consent_html,
            choices: ['I CONSENT TO PARTICIPATE IN THIS STUDY'],
            prompt: '<p><small>Click the button to continue.</small></p>',
            on_load: function () {
                const durationSpan = document.getElementById('duration');
                const benefitsSpan = document.getElementById('benefits');

                if (durationSpan && window.experimentMeta) {
                    durationSpan.textContent = window.experimentMeta.timeRequired;
                }
                if (benefitsSpan && window.experimentMeta) {
                    benefitsSpan.textContent = `You will be compensated with ${window.experimentMeta.payment} (shown in the advertisement).`;
                }
            }
        };

        timeline.push(consentTrial);

        // (Removed redundant getUserID definitions for MTurk, Prolific, and Development Mode)

        var demographics = {
            type: jsPsychSurveyHtmlForm,
            preamble: ["<p><b>We first need some information about you</b></p>"],
            html: '<div align=left>' +

                '<p><b>What is your gender?</b><br>' +
                '<input type="radio" name="gender" value="male" required> Male<br>' +
                '<input type="radio" name="gender" value="female"> Female<br>' +
                '<input type="radio" name="gender" value="other"> Other<br>' +
                '<p>If you chose other, please use your own description: <input type="text" name="gender_response" size="20"/></p>' +

                '<p><b>What is your age?</b><br><input name="age" type="number" required/></p>' +

                '<p><b>How often do you shop for clothing online?</b><br>' +
                '<input type="radio" name="shop_freq" value="Never" required> Never<br>' +
                '<input type="radio" name="shop_freq" value="Occasionally"> Occasionally<br>' +
                '<input type="radio" name="shop_freq" value="Monthly"> Monthly<br>' +
                '<input type="radio" name="shop_freq" value="Weekly"> Weekly<br></p>' +

                '<p><b>Which types of clothing do you typically wear? (Select all that apply)</b><br>' +
                '<input type="checkbox" name="style_casual" value="Casual"> Casual wear<br>' +
                '<input type="checkbox" name="style_formal" value="Formal"> Business/formal wear<br>' +
                '<input type="checkbox" name="style_athleisure" value="Athleisure"> Sportswear/athleisure<br>' +
                '<input type="checkbox" name="style_vintage" value="Vintage"> Vintage/retro styles<br>' +
                '<input type="checkbox" name="style_designer" value="Designer"> Designer/fashion-forward clothing<br>' +
                '<input type="checkbox" name="style_other" value="Other"> Other: <input type="text" name="style_other_text" size="20"/></p>' +

                '<p><b>How would you describe your personal style?</b><br>' +
                '<input type="text" name="style_desc" size="50"/></p>' +


                '</div>',

            data: { test_part: 'Demographics' },
            post_trial_gap: 500,
        };

        // state questions

        var appearanceImportanceQuestion = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '<p><b>How important is your personal appearance to you?</b></p>',
            labels: ['Not important at all', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'],
            slider_width: 600,
            require_movement: true,
            name: 'appearance_importance'
        };

        var wellDressedImportanceQuestion = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '<p><b>How important is it to you that others perceive you as well-dressed?</b></p>',
            labels: ['Not important at all', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'],
            slider_width: 600,
            require_movement: true,
            name: 'well_dressed_importance'
        };

        var comfortImportanceQuestion = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '<p><b>How important is comfort to you when choosing what to wear?</b></p>',
            labels: ['Not important at all', 'Slightly important', 'Moderately important', 'Very important', 'Extremely important'],
            slider_width: 600,
            require_movement: true,
            name: 'comfort_importance'
        };

        var instructions = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/dress_shop.jpg',
            stimulus_width: 400,
            choices: [' '],
            prompt: `
  <p>In this experiment, you will be asked to rate how much you <b>like</b> different dresses.</p>

  <p>You will briefly be shown images of various dresses. After viewing each image, you will rate how much you like the dress using a slider scale from 0 to 100.</p>

  <p>The highest rating (100) should be given to dresses you find particularly attractive or stylish, and the lowest rating (0) to dresses you strongly dislike.</p>

  <p><b>Note:</b> If you do not typically wear dresses yourself, please imagine evaluating them as if you were recommending them to someone else or judging their overall appeal (e.g., design, style, color).</p>

  <p><b>Warning:</b> We want your immediate first impression, so the images will be shown very briefly (less than half a second). It is important that you are ready before you advance to the next trial.</p>

  <p><b>The experiment takes about 45 minutes.</b> We’ve built in breaks every 15 minutes. Please try to complete full blocks. If you need to pause in the middle of a block, just wait before pressing the continue button.</p>

  <p><b>We will collect multiple ratings for each dress.</b> If you notice a dress is repeated, that is intentional—we're collecting several ratings per item.</p>

  <p><b>Before we start, we’ll show you a few examples to get you warmed up.</b></p>

  <p><b>Press the space bar to begin.</b></p>
`,
        };



        if (flowFlags.showSurvey) {
            timeline.push(demographics);
            timeline.push(appearanceImportanceQuestion);
            timeline.push(wellDressedImportanceQuestion);
            timeline.push(comfortImportanceQuestion);
        }

        if (flowFlags.showInstructions) {
            timeline.push(instructions);
        }

        //     /* define fixation and test trials */
        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p style="font-size: 48px;">+</p>',
            choices: "NO_KEYS",
            trial_duration: displayTimings.fixation,
        };

        var show_wild_dress_stimulus = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/crazy_dress.jpg',
            stimulus_width: 400,
            choices: "NO_KEYS",
            stimulus_duration: displayTimings.stimulus,
            trial_duration: displayTimings.responseDelay + displayTimings.stimulus,
            data: {
                task: 'show stimulus',
            },
            on_finish: console.log(jsPsych.data.getLastTimelineData())
        };

        var wild_dress_trial_experiment = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '',
            labels: sliderString,
            slider_start: getRandomInt(1, 99),
            require_movement: true,
            stimulus_duration: displayTimings.image,
            prompt: '<p>' + promptString + '</b>.</p>',
        };

        var wild_dress_feedback = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/crazy_dress.jpg',
            stimulus_width: 400,
            choices: [' '],
            prompt: `
            <p> <b> I'd give this one a low rating (10). A bit to wild for my tastes. That said, some like the attention it would draw and appreciate the style.
                To each thier own. </b> <p>
            
            Let's try a few more examples before we begin.

            <p>Press the space bar to continue.</p>
        `,
        };

        var show_elegant_dress_stimulus = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/nice_dress.jpg',
            stimulus_width: 400,
            choices: "NO_KEYS",
            stimulus_duration: displayTimings.stimulus,
            trial_duration: displayTimings.responseDelay + displayTimings.stimulus,
            data: {
                task: 'show stimulus',
            },
            on_finish: console.log(jsPsych.data.getLastTimelineData())
        };

        var elegant_dress_trial_experiment = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '',
            labels: sliderString,
            slider_start: getRandomInt(1, 99),
            require_movement: true,
            stimulus_duration: displayTimings.image,
            prompt: '<p>' + promptString + '</b>.</p>',
        };

        var elegant_dress_feedback = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/nice_dress.jpg',
            stimulus_width: 400,
            choices: [' '],
            prompt: `
            <p> <b> Oh, this one I like. Simple, elegant! I'd give it a very high rating (90). But I guess others might not like it. 
                This is really about your opinion. </b> <p>
            
            Let's try one more before we begin.

            <p>Press the space bar to continue.</p>
        `,
        };

        var show_retro_dress_stimulus = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/simple_dress.jpg',
            stimulus_width: 400,
            choices: "NO_KEYS",
            stimulus_duration: displayTimings.stimulus,
            trial_duration: displayTimings.responseDelay + displayTimings.stimulus,
            data: {
                task: 'show stimulus',
            },
            on_finish: console.log(jsPsych.data.getLastTimelineData())
        };

        var retro_dress_trial_experiment = {
            type: jsPsychHtmlSliderResponse,
            stimulus: '',
            labels: sliderString,
            slider_start: getRandomInt(1, 99),
            require_movement: true,
            stimulus_duration: displayTimings.image,
            prompt: '<p>' + promptString + '</b>.</p>',
        };

        var retro_dress_feedback = {
            type: jsPsychImageKeyboardResponse,
            stimulus: 'img/simple_dress.jpg',
            stimulus_width: 400,
            choices: [' '],
            prompt: `
            <p> <b> Yeah, this one I also like. It's not super exciting, but I like the retro. I'd give it a 65.  
                We all have our individual preferences. For each dress, tell us how much you like the dress. </b> <p>
            
            Let's start the experiment.

            <p>Press the space bar to continue.</p>
        `,
        };


        if (flowFlags.showExamples) {
            // Example set: Wild dress stimulus and rating trial
            timeline.push(fixation);
            timeline.push(show_wild_dress_stimulus);
            timeline.push(wild_dress_trial_experiment);
            timeline.push(wild_dress_feedback);

            // Example set: Elegant dress stimulus and rating trial
            timeline.push(fixation);
            timeline.push(show_elegant_dress_stimulus);
            timeline.push(elegant_dress_trial_experiment);
            timeline.push(elegant_dress_feedback);

            // Example set: Retro dress stimulus and rating trial
            timeline.push(fixation);
            timeline.push(show_retro_dress_stimulus);
            timeline.push(retro_dress_trial_experiment);
            timeline.push(retro_dress_feedback);
        }

        let Fullimage_stimuli = make_blocks(image_stimuli);
        let stim_cont = 0;

        for (let block_num = 0; block_num < displayTimings.nBlocks; block_num++) {
            for (let event_num = 0; event_num < (image_stimuli.length); event_num++) {
                timeline.push(fixation);
                var show_stimulus = {
                    type: jsPsychImageKeyboardResponse,
                    stimulus: 'dresses/' + Fullimage_stimuli[stim_cont],
                    stimulus_width: 400,
                    choices: "NO_KEYS",
                    stimulus_duration: displayTimings.stimulus,
                    trial_duration: displayTimings.responseDelay + displayTimings.stimulus,
                    data: {
                        task: 'show stimulus',
                    },
                    // on_finish: console.log(jsPsych.data.getLastTimelineData())
                };
                timeline.push(show_stimulus);
                var trial_experiment = {
                    type: jsPsychHtmlSliderResponse,
                    stimulus: '',
                    labels: sliderString,
                    require_movement: true,
                    slider_start: getRandomInt(1, 99),
                    stimulus_duration: displayTimings.image,
                    prompt: '<p>' + promptString + '</b>.</p>',
                    data: { stim_name: Fullimage_stimuli[stim_cont], block_num: block_num + 1, block_trail_num: event_num + 1, isExpt: true }
                };
                timeline.push(trial_experiment);
                stim_cont = stim_cont + 1;
            }
            if (block_num < displayTimings.nBlocks - 1) {
                var take_a_break = {
                    type: jsPsychImageKeyboardResponse,
                    stimulus: 'img/dress_shop.jpg',
                    stimulus_width: 400,
                    choices: [' '],
                    prompt: `
                  <p> That completes block ${block_num + 1} of ${displayTimings.nBlocks}. Take a break and return when you are ready.  <p> <p>
                  <p><b>Press the space bar to resume.</b></p>
              `,
                };
                timeline.push(take_a_break);
            }
        }

        if (flowFlags.showReceipt) {
            // First define and push receipt
            let receipt = {
                type: jsPsychImageKeyboardResponse,
                stimulus: 'img/dress_shop.jpg',
                stimulus_width: 400,
                choices: [' '],
                prompt: function () {
                    var participantID = jsPsych.data.get().select('participantID').values[0];
                    var platform = jsPsych.data.get().select('platform').values[0] || 'Unknown';
                    var creditCode = experimentMeta.creditCode || 'UNKNOWN_CODE';

                    return `
                        <p>Thank you. You are all done.<br>This session was run via: <b>${platform}</b><br><br>
                        <b>Completion Code: ${creditCode}</b><br><br>
                        <button id="copy-code-btn" style="margin-top:10px;">Copy Completion Code</button>
                        <p>Please take a screenshot or copy the code above as confirmation of your participation.</p>
                        <p><b>Participant ID: ${participantID}</b></p>
                        <p>Press the space bar to finish.</p>
                    `;
                },
                on_load: function () {
                    const creditCode = experimentMeta.creditCode || 'UNKNOWN_CODE';
                    const button = document.getElementById('copy-code-btn');
                    if (button) {
                        button.addEventListener('click', function () {
                            navigator.clipboard.writeText(creditCode).then(function () {
                                alert('Completion code copied to clipboard!');
                            });
                        });
                    }
                }
            };
            timeline.push(receipt);
            // Then define and push upload_data_trial
            let upload_data_trial = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
            <div style="text-align:center; font-family:Arial, sans-serif;">
              <p>Finalizing your data... Please wait.</p>
              <div style="margin-top:20px;">
                <div class="loader"></div>
              </div>
            </div>
          `,
                choices: "NO_KEYS",
                trial_duration: 1000, // 1 second to show the spinner while saving
                on_start: function () {
                    if (IsProlific) {
                        console.log("AUTO UPLOAD FOR PROLIFIC");
                        endExperiment(jsPsych.data.get().csv(), function () { });
                    }
                    if (IsMTurk) {
                        console.log("AUTO UPLOAD FOR MTURK");
                        endExperiment(jsPsych.data.get().csv(), function () { });
                    }
                    if (LocalSave) {
                        console.log("LOCAL SAVE");
                        jsPsych.data.get().localSave('csv', 'dress_ratings.csv');
                    }
                }
            };
            timeline.push(upload_data_trial);
        }

        /* finish connection with pavlovia.org */
        var pavlovia_finish = {
            type: jsPsychPavlovia,
            command: "finish",
            stimulus: `
      <div style="text-align: center; font-family: Arial, sans-serif; padding-top: 20vh;">
        <h2>Uploading your responses...</h2>
        <p>Almost done! Please do not close this window.</p>
        <div style="margin-top: 30px;">
          <div class="loader"></div>
        </div>
      </div>
    `,
            on_finish: function () {
                if (IsProlific) {
                    console.log("Redirecting to Prolific after Pavlovia finish...");
                    window.location = "https://app.prolific.co/submissions/complete?cc=" + experimentMeta.creditCode;
                }
            }
        };
        timeline.push(pavlovia_finish);
        jsPsych.run(timeline);
    }

    function endExperiment(dataset, callback) {
        setTimeout(callback, 500)
    }
</script>

</html>